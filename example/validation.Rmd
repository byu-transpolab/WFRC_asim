---
title: "Validation"
author: "Christian Hunter"
date: "8/5/2020"
output: html_document
---
```{r wfrc_tables}
library(tidyverse)
BiocManager::install("rhdf5")
library(rhdf5)
library(future.apply)

## Read in output files
wfrc_trips <- read_csv("validation/WFRC_trips.csv")
wfrc_school <- read_csv("validation/WFRC_school.csv")
as_trips <- read_csv("output/final_trips.csv")
as_tours <- read_csv("output/final_tours.csv", col_types = list(
  composition = col_character(), parent_tour_id = col_integer()))

## Modes List
auto <- c('DRIVEALONEFREE', "DRIVEALONETOLL", "SHARED2FREE", "SHARED2TOLL", 
          "SHARED3FREE", "SHARED3TOLL")
nonmotor <- c("NONMOTOR")
nonmotor_as <- c("BIKE", "WALK")
transit <- c("WALK_LOC", "DRIVE_LOC", "WALK_MAX", 'DRIVE_MAX', 'WALK_BRT', 'DRIVE_BRT',
             'WALK_EXP', 'DRIVE_EXP', 'WALK_TRAX', 'DRIVE_TRAX', 'WALK_COM', 'DRIVE_COM')
transit_as <- c("WALK_LOC", "DRIVE_LOC", "WALK_MAX", 'DRIVE_MAX', 'WALK_HVY', 'DRIVE_HVY',
             'WALK_EXP', 'DRIVE_EXP', 'WALK_LRF', 'DRIVE_LRF', 'WALK_COM', 'DRIVE_COM')
totals <- c('AUTO_TOTAL', 'TRANSIT_TOTAL')
combined_modes <- auto %>% 
  append(nonmotor) %>% 
  append(transit) %>% 
  append(totals)

## Organize WFRC summary to align with AS format
index_row <- c(6,7,9,10,13,14,2,18,19,21,22,24,25,27,28,30,31,33,34,1,16)
index_col <- c(2,5,8,11)
trip_types <- c("HWB_wf", "HBC_wf", "HBO_wf", "NHB_wf")
comp_table <- as.data.frame(combined_modes) 
comp_table[, trip_types] <- NA
for (type in 1:length(trip_types)){
  for (i in 1:length(index_row)){
    if (i == 1){
      vals <- wfrc_trips[index_row[i], index_col[type]]
    } else{
      vals <- vals %>% 
        append(wfrc_trips[index_row[i], index_col[type]])
    }
  }
  comp_table[[type + 1]] <- vals
}
```

```{r county_matrix}
## Read in crosswalk from PopulationSim and list of external TAZs, remove these TAZs
xTAZs <- read_csv("validation/external_tazs.csv")
ps_xw <- read_csv("validation/geo_cross_walk.csv") %>% 
  filter(!TAZ %in% xTAZs$xTAZ) %>% 
  mutate(
    TAZ2 = case_when(
      TAZ < 136 ~ TAZ,
      TAZ > 140 & TAZ < 421 ~ (TAZ - 5),
      TAZ > 422 & TAZ < 1782 ~ (TAZ -7),
      T ~ (TAZ - 14)
    )
  ) %>% 
  subset(select = -c(TAZ, REGION, TRACT, geometry)) %>% 
  rename(TAZ = TAZ2)

## Find county for each trip origin and destination
as_trips <- as_trips %>% 
  mutate(
    ocounty = case_when(
      origin < 136 ~ "Box_Elder",
      origin > 135 & origin < 417 ~ "Weber",
      origin > 416 & origin < 648 ~ "Davis",
      origin > 647 & origin < 1775 ~ "Salt_Lake",
      origin > 1774 & origin < 2860 ~ "Utah",
      T ~ "NA"
    ),
    dcounty = case_when(
      destination < 136 ~ "Box_Elder",
      destination > 135 & destination < 417 ~ "Weber",
      destination > 416 & destination < 648 ~ "Davis",
      destination > 647 & destination < 1775 ~ "Salt_Lake",
      destination > 1774 & destination < 2860 ~ "Utah",
      T ~ "NA")
  )

## Create OD matrix
od <- as_trips %>% 
  group_by(ocounty, dcounty) %>% 
  tally() %>% 
  spread(dcounty, n)
```

```{r distance}
## Create trip length frequency distribution
skims = H5Fopen("data/skims_wfrc.omx")
dist = skims$"/data/DIST" %>% 
  as.data.frame()
distance <- rep(1, nrow(as_trips))
o_col <- as_trips$origin
d_col <- as_trips$destination

## Be patient, takes a couple minutes
for (i in 1:nrow(as_trips)){
  o <- o_col[i]
  d <- d_col[i]
  distance[i] <- dist[o,d]
}
## Histogram
as_trips <- as_trips%>% mutate(trip_length = distance)
ggplot(as_trips) + geom_histogram(aes(x = trip_length), binwidth = .5) + xlim(0,20) + 
  theme_bw(base_size = 18) + labs(y = "Frequency", x = "Trip Length")
## Line graph
ggplot(as_trips) + geom_freqpoly(aes(x = trip_length), binwidth = .25) + xlim(0,20) + 
  theme_bw(base_size = 18) + labs(y = "Frequency", x = "Trip Length")
## Line graph, segmented by mode
ggplot(as_trips) + geom_density(aes(x = trip_length, color = trip_mode)) + xlim(0,20) + 
  theme_bw(base_size = 18) + labs(y = "Frequency", x = "Trip Length", color = "Mode")
## Automobile modes
tlfd_a <- as_trips %>% 
  filter(trip_mode %in% auto) %>% 
  select(c(trip_mode, trip_length))
ggplot(tlfd_a) + geom_density(aes(x = trip_length, color = trip_mode)) + xlim(0,20) + 
  theme_bw(base_size = 18) + labs(y = "Frequency", x = "Trip Length", color = "Mode")
## Nonmotorized modes
tlfd_n <- as_trips %>% 
  filter(trip_mode %in% nonmotor_as) %>% 
  select(c(trip_mode, trip_length))
ggplot(tlfd_n) + geom_density(aes(x = trip_length, color = trip_mode)) + xlim(0,20) + 
  theme_bw(base_size = 18) + labs(y = "Frequency", x = "Trip Length", color = "Mode")
## Transit modes
tlfd_t <- as_trips %>% 
  filter(trip_mode %in% transit_as) %>% 
  select(c(trip_mode, trip_length))
ggplot(tlfd_t) + geom_density(aes(x = trip_length, color = trip_mode)) + xlim(0,40) + 
theme_bw(base_size = 18) + labs(y = "Frequency", x = "Trip Length", color = "Mode")
## By mode group
as_trips <- as_trips %>% 
  mutate(
    mode_group = case_when(
      trip_mode %in% auto ~ "Auto",
      trip_mode %in% nonmotor_as ~"Nonmotorized",
      trip_mode %in% transit_as ~ "Transit"
    )
  )
ggplot(as_trips) + geom_density(aes(x = trip_length, color = mode_group)) + xlim(0,40) + 
theme_bw(base_size = 18) + labs(y = "Frequency", x = "Trip Length", color = "Mode")
## There is a large difference between nonmotorized and the other two groups, so separate them
a_vs_t <- as_trips %>% 
  select(c(trip_length, mode_group)) %>% 
  filter(!mode_group == "Nonmotorized")
ggplot(a_vs_t) + geom_density(aes(x = trip_length, color = mode_group)) + xlim(0,40) + 
theme_bw(base_size = 18) + labs(y = "Frequency", x = "Trip Length", color = "Mode")
```

```{r as_stats}
## Show all AS trip combinations
combos <- group_by(as_trips, primary_purpose, purpose, trip_count) %>% tally() %>% print(n=100)

## Get HBW stats
as_hbw <- as_trips %>% 
  mutate(labels = case_when(
    trip_num == 1 & purpose == "work" ~ "HBW",
    trip_num == 1 & purpose == "Home" & primary_purpose == "work" ~ "HBW"
  )) %>% 
  group_by(labels, trip_mode) %>%
  tally() %>% 
  filter(labels %in% "HBW")

## Get HBO stats
as_hbo <- as_trips %>% 
  mutate(labels = case_when(
    trip_num == 1 & purpose != "work" & primary_purpose != "atwork" & 
    purpose != "school" ~ "HBO"
  )) %>% 
  group_by(labels, trip_mode) %>%
  tally() %>% 
  filter(labels %in% "HBO")

## Get NHB stats
as_nhb <- as_trips %>% 
   mutate(labels = case_when(
    trip_num == 1 & primary_purpose == "work" & purpose != "work" & purpose != "Home" ~ "NHB" 
  )) %>% 
  group_by(labels, trip_mode) %>%
  tally() %>% 
  filter(labels %in% "NHB")

## Get HBShop stats
as_hbc <- as_trips %>%
 mutate(labels = case_when(
    trip_num == 1 & primary_purpose == "work" & purpose != "work" ~ "HBC"
  )) %>% 
  group_by(labels, trip_mode) %>%
  tally() %>% 
  filter(labels %in% "HBC") 

## Combine tables
comp_table <- comp_table %>% 
  add_column(HBW_as = 0, .after = 2) %>% 
  add_column(HBO_as = 0, .after = 5)
for (i in 1: length(as_hbw$trip_mode)){
  row = match(as_hbw$trip_mode[i], combined_modes)
  comp_table$HBW_as[row] = as_hbw$n[i]
}
for (i in 1: length(as_hbo$trip_mode)){
  row = match(as_hbo$trip_mode[i], combined_modes)
  comp_table$HBO_as[row] = as_hbo$n[i]
}



```
